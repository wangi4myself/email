# Actix-webã€Tokio ä¸ Reqwest ä»‹ç»

æœ¬æ–‡æ¡£ä»‹ç» Rust å¼‚æ­¥ç”Ÿæ€ä¸­ä¸‰ä¸ªæ ¸å¿ƒç»„ä»¶ï¼Œå¹¶ç»“åˆæœ¬é¡¹ç›®çš„å®é™…ä»£ç è¿›è¡Œè¯´æ˜ã€‚

## å¿«é€Ÿç±»æ¯”ï¼šNode.js å¼€å‘è€…è§†è§’

| Rust ç”Ÿæ€     | Node.js ç”Ÿæ€             | ä½œç”¨                               |
| ------------- | ------------------------ | ---------------------------------- |
| **Tokio**     | Node.js äº‹ä»¶å¾ªç¯ (libuv) | å¼‚æ­¥è¿è¡Œæ—¶ï¼Œå¤„ç† I/O äº‹ä»¶          |
| **actix-web** | Express.js / Fastify     | Web æ¡†æ¶ï¼Œå¤„ç† HTTP è¯·æ±‚ï¼ˆæœåŠ¡ç«¯ï¼‰ |
| **reqwest**   | axios / node-fetch       | HTTP å®¢æˆ·ç«¯ï¼Œå‘é€è¯·æ±‚ï¼ˆå®¢æˆ·ç«¯ï¼‰    |
| `async/await` | `async/await`            | è¯­æ³•ç³–ï¼Œç¼–å†™å¼‚æ­¥ä»£ç                |

## Tokioï¼šå¼‚æ­¥è¿è¡Œæ—¶

### æ˜¯ä»€ä¹ˆï¼Ÿ

Tokio æ˜¯ Rust çš„**å¼‚æ­¥è¿è¡Œæ—¶**ï¼ˆAsync Runtimeï¼‰ã€‚

åœ¨ Node.js ä¸­ï¼ŒV8 å¼•æ“è‡ªå¸¦äº‹ä»¶å¾ªç¯ï¼ˆlibuvï¼‰ï¼Œä½ ä¸éœ€è¦å…³å¿ƒå®ƒã€‚ä½† Rust æ ‡å‡†åº“**ä¸åŒ…å«å¼‚æ­¥è¿è¡Œæ—¶**ï¼Œéœ€è¦è‡ªå·±é€‰æ‹©ä¸€ä¸ªã€‚Tokio æ˜¯æœ€æµè¡Œçš„é€‰æ‹©ã€‚

### æ ¸å¿ƒæ¦‚å¿µ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Tokio Runtime                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚         Event Loop (äº‹ä»¶å¾ªç¯)        â”‚    â”‚
â”‚  â”‚  - ç®¡ç†æ‰€æœ‰å¼‚æ­¥ä»»åŠ¡                  â”‚    â”‚
â”‚  â”‚  - è°ƒåº¦ Future æ‰§è¡Œ                  â”‚    â”‚
â”‚  â”‚  - å¤„ç† I/O äº‹ä»¶                     â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚       Thread Pool (çº¿ç¨‹æ± )           â”‚    â”‚
â”‚  â”‚  - å¤šçº¿ç¨‹æ‰§è¡Œä»»åŠ¡                    â”‚    â”‚
â”‚  â”‚  - å……åˆ†åˆ©ç”¨å¤šæ ¸ CPU                  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### åœ¨é¡¹ç›®ä¸­çš„ä½¿ç”¨

```rust
// src/main.rs
#[tokio::main]  // ğŸ‘ˆ è¿™ä¸ªå®åˆå§‹åŒ– Tokio è¿è¡Œæ—¶
async fn main() -> std::io::Result<()> {
    // ...
    run(listener, connection_pool, email_client)?.await?;  // ğŸ‘ˆ .await éœ€è¦è¿è¡Œæ—¶æ¥æ‰§è¡Œ
    Ok(())
}
```

**`#[tokio::main]` å®å±•å¼€åç›¸å½“äºï¼š**

```rust
fn main() -> std::io::Result<()> {
    tokio::runtime::Builder::new_multi_thread()
        .enable_all()
        .build()
        .unwrap()
        .block_on(async {
            // ä½ çš„ async main ä»£ç 
        })
}
```

### Cargo.toml é…ç½®

```toml
tokio = { version = "1", features = ["macros", "rt-multi-thread"] }
```

| Feature           | è¯´æ˜                         |
| ----------------- | ---------------------------- |
| `macros`          | å¯ç”¨ `#[tokio::main]` ç­‰å®   |
| `rt-multi-thread` | å¤šçº¿ç¨‹è¿è¡Œæ—¶ï¼ˆç”Ÿäº§ç¯å¢ƒæ¨èï¼‰ |

### ä¸ Node.js çš„å…³é”®åŒºåˆ«

| ç‰¹æ€§         | Node.js        | Tokio            |
| ------------ | -------------- | ---------------- |
| çº¿ç¨‹æ¨¡å‹     | å•çº¿ç¨‹äº‹ä»¶å¾ªç¯ | å¤šçº¿ç¨‹è¿è¡Œæ—¶     |
| CPU å¯†é›†ä»»åŠ¡ | é˜»å¡ä¸»çº¿ç¨‹     | å¯åˆ†é…åˆ°å…¶ä»–çº¿ç¨‹ |
| é»˜è®¤å¯ç”¨     | âœ… å†…ç½®        | âŒ éœ€è¦å¼•å…¥      |

## Actix-webï¼šWeb æ¡†æ¶

### æ˜¯ä»€ä¹ˆï¼Ÿ

Actix-web æ˜¯åŸºäº Actix actor æ¡†æ¶æ„å»ºçš„é«˜æ€§èƒ½ Web æ¡†æ¶ï¼Œç±»ä¼¼äº Node.js ä¸­çš„ Express æˆ– Fastifyã€‚

### æ€§èƒ½å¯¹æ¯”

æ ¹æ® TechEmpower åŸºå‡†æµ‹è¯•ï¼ŒActix-web æ˜¯æœ€å¿«çš„ Web æ¡†æ¶ä¹‹ä¸€ï¼š

```
Actix-web (Rust)    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 600k+ req/s
Fastify (Node.js)   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ                  280k req/s
Express (Node.js)   â–ˆâ–ˆâ–ˆâ–ˆ                          100k req/s
```

### æ ¸å¿ƒæ¦‚å¿µ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    HttpServer                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                    App                           â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚  â”‚
â”‚  â”‚  â”‚              Middleware                  â”‚    â”‚  â”‚
â”‚  â”‚  â”‚  (TracingLogger, CORS, Auth, etc.)      â”‚    â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚  â”‚
â”‚  â”‚  â”‚               Routes                     â”‚    â”‚  â”‚
â”‚  â”‚  â”‚  /health_check  â†’  health_check()       â”‚    â”‚  â”‚
â”‚  â”‚  â”‚  /subscriptions â†’  subscribe()          â”‚    â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚  â”‚
â”‚  â”‚  â”‚            App Data (å…±äº«çŠ¶æ€)           â”‚    â”‚  â”‚
â”‚  â”‚  â”‚  - db_pool (æ•°æ®åº“è¿æ¥æ± )               â”‚    â”‚  â”‚
â”‚  â”‚  â”‚  - email_client (é‚®ä»¶å®¢æˆ·ç«¯)            â”‚    â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### åœ¨é¡¹ç›®ä¸­çš„ä½¿ç”¨

```rust
// src/startup.rs
use actix_web::{dev::Server, web, App, HttpServer};

pub fn run(
    listener: TcpListener,
    db_pool: PgPool,
    email_client: EmailClient,
) -> Result<Server, std::io::Error> {
    // 1. åŒ…è£…å…±äº«çŠ¶æ€
    let db_pool = web::Data::new(db_pool);        // ç±»ä¼¼ Express çš„ app.locals
    let email_client = web::Data::new(email_client);

    // 2. åˆ›å»º HTTP æœåŠ¡å™¨
    let server = HttpServer::new(move || {
        App::new()
            // 3. æ·»åŠ ä¸­é—´ä»¶ (ç±»ä¼¼ Express çš„ app.use())
            .wrap(TracingLogger::default())
            // 4. å®šä¹‰è·¯ç”± (ç±»ä¼¼ Express çš„ app.get() / app.post())
            .route("/health_check", web::get().to(health_check))
            .route("/subscriptions", web::post().to(subscribe))
            // 5. æ³¨å…¥å…±äº«çŠ¶æ€
            .app_data(db_pool.clone())
            .app_data(email_client.clone())
    })
    .listen(listener)?
    .run();

    Ok(server)
}
```

### å¯¹æ¯” Express.js

```javascript
// Express.js ç‰ˆæœ¬
const express = require("express");
const app = express();

// ä¸­é—´ä»¶
app.use(loggingMiddleware);

// å…±äº«çŠ¶æ€
app.locals.dbPool = dbPool;
app.locals.emailClient = emailClient;

// è·¯ç”±
app.get("/health_check", healthCheck);
app.post("/subscriptions", subscribe);

app.listen(8000);
```

```rust
// Actix-web ç‰ˆæœ¬
let server = HttpServer::new(move || {
    App::new()
        // ä¸­é—´ä»¶
        .wrap(TracingLogger::default())
        // å…±äº«çŠ¶æ€
        .app_data(web::Data::new(db_pool.clone()))
        .app_data(web::Data::new(email_client.clone()))
        // è·¯ç”±
        .route("/health_check", web::get().to(health_check))
        .route("/subscriptions", web::post().to(subscribe))
})
.bind("127.0.0.1:8000")?
.run();
```

## ä¸¤è€…å¦‚ä½•åä½œ

```
è¯·æ±‚æµç¨‹:

  HTTP Request
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Actix-web     â”‚  æ¥æ”¶è¯·æ±‚ï¼Œåˆ†å‘åˆ° handler
â”‚   (Web æ¡†æ¶)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  async handler  â”‚  æ‰§è¡Œä¸šåŠ¡é€»è¾‘ (async fn)
â”‚  subscribe()    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚ .await
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     Tokio       â”‚  æ‰§è¡Œæ•°æ®åº“æŸ¥è¯¢ã€ç½‘ç»œè¯·æ±‚ç­‰ I/O
â”‚   (å¼‚æ­¥è¿è¡Œæ—¶)   â”‚  åœ¨ç­‰å¾… I/O æ—¶å¤„ç†å…¶ä»–è¯·æ±‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
  HTTP Response
```

### å®é™…ä»£ç æµç¨‹

```rust
// 1. Tokio è¿è¡Œæ—¶å¯åŠ¨
#[tokio::main]
async fn main() {
    // 2. åˆ›å»º Actix-web æœåŠ¡å™¨
    let server = run(listener, db_pool, email_client)?;

    // 3. Tokio è¿è¡Œæ—¶é©±åŠ¨æœåŠ¡å™¨è¿è¡Œ
    server.await?;
}

// 4. å½“è¯·æ±‚åˆ°è¾¾ï¼ŒActix è°ƒç”¨ handler
async fn subscribe(
    form: web::Form<FormData>,
    pool: web::Data<PgPool>,
) -> HttpResponse {
    // 5. Tokio æ‰§è¡Œæ•°æ®åº“æŸ¥è¯¢
    sqlx::query!(...)
        .execute(pool.get_ref())
        .await  // ğŸ‘ˆ åœ¨ç­‰å¾…æ—¶ï¼ŒTokio å¯ä»¥å¤„ç†å…¶ä»–è¯·æ±‚
        .expect("Failed to execute query.");

    HttpResponse::Ok().finish()
}
```

## ä¸ºä»€ä¹ˆéœ€è¦ä¸¤è€…ï¼Ÿ

| é—®é¢˜                           | Tokio è§£å†³     | Actix-web è§£å†³ | Reqwest è§£å†³ |
| ------------------------------ | -------------- | -------------- | ------------ |
| å¦‚ä½•è¿è¡Œå¼‚æ­¥ä»£ç ï¼Ÿ             | âœ…             |                |              |
| å¦‚ä½•å¤„ç† HTTP è¯·æ±‚ï¼ˆæœåŠ¡ç«¯ï¼‰ï¼Ÿ |                | âœ…             |              |
| å¦‚ä½•å‘é€ HTTP è¯·æ±‚ï¼ˆå®¢æˆ·ç«¯ï¼‰ï¼Ÿ |                |                | âœ…           |
| å¦‚ä½•å®ç°è·¯ç”±ï¼Ÿ                 |                | âœ…             |              |
| å¦‚ä½•æ³¨å…¥ä¾èµ–ï¼Ÿ                 |                | âœ…             |              |
| å¦‚ä½•å¹¶å‘å¤„ç†è¯·æ±‚ï¼Ÿ             | âœ…             |                |              |
| å¦‚ä½•æ‰§è¡Œæ•°æ®åº“æŸ¥è¯¢ï¼Ÿ           | âœ… (é€šè¿‡ sqlx) |                |              |
| å¦‚ä½•è°ƒç”¨å¤–éƒ¨ APIï¼Ÿ             |                |                | âœ…           |

**ç®€å•æ€»ç»“ï¼š**

- **Tokio** = å¼•æ“ï¼ˆæä¾›åŠ¨åŠ›ï¼‰
- **Actix-web** = è½¦èº«ï¼ˆæ¥æ”¶è¯·æ±‚ï¼‰
- **Reqwest** = ä¿¡ä½¿ï¼ˆå‘é€è¯·æ±‚ï¼‰

æ²¡æœ‰ Tokioï¼Œå¼‚æ­¥ä»£ç æ— æ³•è¿è¡Œã€‚æ²¡æœ‰ Actix-webï¼Œä½ éœ€è¦è‡ªå·±è§£æ HTTP è¯·æ±‚ã€‚

## Reqwestï¼šHTTP å®¢æˆ·ç«¯

### æ˜¯ä»€ä¹ˆï¼Ÿ

Reqwest æ˜¯ Rust æœ€æµè¡Œçš„ **HTTP å®¢æˆ·ç«¯**åº“ï¼Œç±»ä¼¼äº Node.js ä¸­çš„ axios æˆ– node-fetchã€‚

**å…³é”®åŒºåˆ«ï¼š**

- **Actix-web** = HTTP æœåŠ¡ç«¯ï¼ˆæ¥æ”¶è¯·æ±‚ï¼‰
- **Reqwest** = HTTP å®¢æˆ·ç«¯ï¼ˆå‘é€è¯·æ±‚ï¼‰

### å¯¹æ¯” Node.js

| Rust (reqwest)                 | Node.js                 | è¯´æ˜                   |
| ------------------------------ | ----------------------- | ---------------------- |
| `reqwest::Client`              | `axios.create()`        | åˆ›å»ºå¯å¤ç”¨çš„å®¢æˆ·ç«¯å®ä¾‹ |
| `client.get(url)`              | `axios.get(url)`        | å‘é€ GET è¯·æ±‚          |
| `client.post(url).json(&data)` | `axios.post(url, data)` | å‘é€ POST JSON è¯·æ±‚    |
| `.send().await`                | `await axios.get()`     | å¼‚æ­¥ç­‰å¾…å“åº”           |

### åœ¨é¡¹ç›®ä¸­çš„ä½¿ç”¨

```rust
// src/email_client.rs
use reqwest::Client;

pub struct EmailClient {
    http_client: Client,      // ğŸ‘ˆ reqwest å®¢æˆ·ç«¯
    base_url: String,
    sender: SubscriberEmail,
}

impl EmailClient {
    pub fn new(base_url: String, sender: SubscriberEmail) -> Self {
        Self {
            http_client: Client::new(),  // ğŸ‘ˆ åˆ›å»ºå®¢æˆ·ç«¯å®ä¾‹
            base_url,
            sender,
        }
    }

    pub async fn send_email(&self, ...) -> Result<(), reqwest::Error> {
        self.http_client
            .post(&format!("{}/email", self.base_url))
            .json(&email_body)
            .send()        // ğŸ‘ˆ å‘é€è¯·æ±‚
            .await?;       // ğŸ‘ˆ å¼‚æ­¥ç­‰å¾…
        Ok(())
    }
}
```

### å¯¹æ¯” axios

```javascript
// Node.js (axios) ç‰ˆæœ¬
const axios = require("axios");

class EmailClient {
  constructor(baseUrl, sender) {
    this.httpClient = axios.create({ baseURL: baseUrl });
    this.sender = sender;
  }

  async sendEmail(recipient, subject, htmlContent, textContent) {
    await this.httpClient.post("/email", {
      from: this.sender,
      to: recipient,
      subject,
      html: htmlContent,
      text: textContent,
    });
  }
}
```

```rust
// Rust (reqwest) ç‰ˆæœ¬
use reqwest::Client;

pub struct EmailClient {
    http_client: Client,
    base_url: String,
    sender: SubscriberEmail,
}

impl EmailClient {
    pub async fn send_email(
        &self,
        recipient: &SubscriberEmail,
        subject: &str,
        html_content: &str,
        text_content: &str,
    ) -> Result<(), reqwest::Error> {
        self.http_client
            .post(&format!("{}/email", self.base_url))
            .json(&serde_json::json!({
                "from": self.sender.as_ref(),
                "to": recipient.as_ref(),
                "subject": subject,
                "html": html_content,
                "text": text_content,
            }))
            .send()
            .await?
            .error_for_status()?;  // ç±»ä¼¼ axios çš„è‡ªåŠ¨é”™è¯¯å¤„ç†
        Ok(())
    }
}
```

### Cargo.toml é…ç½®

```toml
reqwest = { version = "0.11", default-features = false, features = [
    "json",          # æ”¯æŒ JSON åºåˆ—åŒ–/ååºåˆ—åŒ–
    "rustls-tls",    # ä½¿ç”¨ rustls ä½œä¸º TLS åç«¯ï¼ˆçº¯ Rust å®ç°ï¼‰
    "cookies",       # æ”¯æŒ Cookie å¤„ç†
]}
```

| Feature                    | è¯´æ˜                                               |
| -------------------------- | -------------------------------------------------- |
| `json`                     | å¯ç”¨ `.json()` æ–¹æ³•                                |
| `rustls-tls`               | ä½¿ç”¨ Rust åŸç”Ÿ TLSï¼ˆvs `native-tls` ä½¿ç”¨ç³»ç»Ÿ TLSï¼‰ |
| `cookies`                  | è‡ªåŠ¨å¤„ç† Cookie                                    |
| `default-features = false` | ç¦ç”¨é»˜è®¤çš„ `native-tls`ï¼Œå‡å°‘ä¾èµ–                  |

### å¸¸ç”¨æ“ä½œç¤ºä¾‹

```rust
use reqwest::Client;

// åˆ›å»ºå®¢æˆ·ç«¯ï¼ˆå»ºè®®å¤ç”¨ï¼Œä¸è¦æ¯æ¬¡è¯·æ±‚éƒ½åˆ›å»ºï¼‰
let client = Client::new();

// GET è¯·æ±‚
let response = client
    .get("https://api.example.com/users")
    .header("Authorization", "Bearer token")
    .send()
    .await?;

// POST JSON
let user = serde_json::json!({ "name": "Alice", "email": "alice@example.com" });
let response = client
    .post("https://api.example.com/users")
    .json(&user)
    .send()
    .await?;

// è§£æ JSON å“åº”
let user: User = response.json().await?;

// è·å–çŠ¶æ€ç 
if response.status().is_success() {
    println!("Success!");
}

// è·å–å“åº”æ–‡æœ¬
let text = response.text().await?;
```

### ä¸ Tokio çš„å…³ç³»

Reqwest ä¾èµ– Tokio è¿è¡Œæ—¶æ¥æ‰§è¡Œå¼‚æ­¥ HTTP è¯·æ±‚ï¼š

```
å‘é€é‚®ä»¶æµç¨‹:

  EmailClient.send_email()
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Reqwest      â”‚  æ„å»º HTTP è¯·æ±‚
â”‚  (HTTP å®¢æˆ·ç«¯)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚ .send().await
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     Tokio       â”‚  æ‰§è¡Œç½‘ç»œ I/O
â”‚   (å¼‚æ­¥è¿è¡Œæ—¶)   â”‚  å¤„ç† TCP è¿æ¥ã€TLS æ¡æ‰‹ç­‰
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
  å¤–éƒ¨é‚®ä»¶æœåŠ¡ API
```

### ä¸ºä»€ä¹ˆå¤ç”¨ Clientï¼Ÿ

```rust
// âŒ ä¸æ¨èï¼šæ¯æ¬¡è¯·æ±‚åˆ›å»ºæ–°å®¢æˆ·ç«¯
async fn send_email() {
    let client = Client::new();  // æ¯æ¬¡éƒ½åˆ›å»ºæ–°çš„è¿æ¥æ± 
    client.post(...).send().await;
}

// âœ… æ¨èï¼šå¤ç”¨å®¢æˆ·ç«¯å®ä¾‹
struct EmailClient {
    http_client: Client,  // å¤ç”¨è¿æ¥æ± 
}
```

ç±»ä¼¼äº Node.js ä¸­å¤ç”¨ axios å®ä¾‹ï¼š

- è¿æ¥æ± å¤ç”¨ï¼Œå‡å°‘ TCP æ¡æ‰‹å¼€é”€
- æ›´å¥½çš„æ€§èƒ½
- æ›´å°‘çš„èµ„æºæ¶ˆè€—

## ä¸‰è€…åä½œå…³ç³»

```
å®Œæ•´è¯·æ±‚æµç¨‹ï¼ˆç”¨æˆ·è®¢é˜… â†’ å‘é€ç¡®è®¤é‚®ä»¶ï¼‰:

  ç”¨æˆ· HTTP è¯·æ±‚ (POST /subscriptions)
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Actix-web     â”‚  æ¥æ”¶è¯·æ±‚ï¼Œè·¯ç”±åˆ° handler
â”‚  (Web æœåŠ¡ç«¯)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  subscribe()    â”‚  ä¸šåŠ¡é€»è¾‘ï¼šä¿å­˜ç”¨æˆ·ï¼Œå‘é€é‚®ä»¶
â”‚   handler       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                      â”‚
        â–¼                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     SQLx        â”‚    â”‚    Reqwest      â”‚
â”‚  (æ•°æ®åº“æŸ¥è¯¢)    â”‚    â”‚  (HTTP å®¢æˆ·ç«¯)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                      â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚ .await
                   â–¼
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚     Tokio       â”‚  æ‰§è¡Œæ‰€æœ‰å¼‚æ­¥ I/O
           â”‚   (å¼‚æ­¥è¿è¡Œæ—¶)   â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â–¼                      â–¼
   PostgreSQL            é‚®ä»¶æœåŠ¡ API
```

## å…¶ä»–å¸¸è§é€‰æ‹©

### å¼‚æ­¥è¿è¡Œæ—¶

| è¿è¡Œæ—¶    | ç‰¹ç‚¹               |
| --------- | ------------------ |
| **Tokio** | æœ€æµè¡Œï¼ŒåŠŸèƒ½æœ€å…¨é¢ |
| async-std | ç±»ä¼¼æ ‡å‡†åº“ API     |
| smol      | è½»é‡çº§             |

### Web æ¡†æ¶

| æ¡†æ¶          | ç‰¹ç‚¹                         |
| ------------- | ---------------------------- |
| **Actix-web** | æœ€å¿«ï¼ŒåŠŸèƒ½ä¸°å¯Œ               |
| Axum          | Tokio å®˜æ–¹å›¢é˜Ÿå‡ºå“ï¼Œæ›´ç°ä»£   |
| Rocket        | å¼€å‘ä½“éªŒå¥½ï¼Œåƒ Ruby on Rails |
| Warp          | åŸºäº Filter ç»„åˆ             |

## æ€»ç»“

å¯¹äºç†Ÿæ‚‰ Node.js çš„å¼€å‘è€…ï¼š

```
Node.js æ¶æ„:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Express.js (Web æ¡†æ¶)              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  V8 + libuv (å†…ç½®è¿è¡Œæ—¶)       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Rust æ¶æ„:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Actix-web (Web æ¡†æ¶)               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Tokio (éœ€è¦æ˜¾å¼å¼•å…¥çš„è¿è¡Œæ—¶)  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

æ ¸å¿ƒå·®å¼‚ï¼šNode.js æŠŠè¿è¡Œæ—¶å†…ç½®äº†ï¼ŒRust éœ€è¦ä½ è‡ªå·±é€‰æ‹©å’Œå¼•å…¥ã€‚è¿™æä¾›äº†æ›´å¤§çš„çµæ´»æ€§ï¼Œä½†ä¹Ÿéœ€è¦æ›´å¤šçš„ç†è§£ã€‚

## Wiremockï¼šHTTP Mock æœåŠ¡å™¨

### æ˜¯ä»€ä¹ˆï¼Ÿ

[wiremock](https://crates.io/crates/wiremock) æ˜¯ä¸€ä¸ª Rust çš„ **HTTP mock æœåŠ¡å™¨**åº“ï¼Œä¸“é—¨ç”¨äºæµ‹è¯•ã€‚

**TypeScript ç±»æ¯”ï¼š** ç±»ä¼¼äº `nock` æˆ– `msw` (Mock Service Worker)

### æ ¸å¿ƒæ¦‚å¿µ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        æµ‹è¯•ç¯å¢ƒ                              â”‚
â”‚                                                             â”‚
â”‚  ä½ çš„ä»£ç                     wiremock MockServer            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚          â”‚  HTTP è¯·æ±‚     â”‚                  â”‚           â”‚
â”‚  â”‚ EmailClient â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶  localhost:éšæœºç«¯å£ â”‚           â”‚
â”‚  â”‚          â”‚               â”‚                  â”‚           â”‚
â”‚  â”‚          â”‚ â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  è¿”å›é¢„è®¾å“åº”      â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                                             â”‚
â”‚                         âŒ ä¸ä¼šåˆ°è¾¾                          â”‚
â”‚                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚                     â”‚ api.postmarkapp.com â”‚                   â”‚
â”‚                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å…³é”®ç‚¹ï¼šwiremock åªæ˜¯æ¨¡æ‹Ÿï¼Œä¸ä¼šå®é™…å‘é€è¯·æ±‚åˆ°çœŸå®æœåŠ¡ã€‚**

### åŸºæœ¬ç”¨æ³•

```rust
use wiremock::{MockServer, Mock, ResponseTemplate};
use wiremock::matchers::{method, path};

#[tokio::test]
async fn test_example() {
    // 1. å¯åŠ¨ mock æœåŠ¡å™¨ï¼ˆéšæœºç«¯å£ï¼‰
    let mock_server = MockServer::start().await;

    // 2. å®šä¹‰ mock è§„åˆ™
    Mock::given(method("POST"))           // åŒ¹é… POST è¯·æ±‚
        .and(path("/email"))              // åŒ¹é…è·¯å¾„ /email
        .respond_with(ResponseTemplate::new(200))  // è¿”å› 200
        .expect(1)                        // æœŸæœ›è¢«è°ƒç”¨ 1 æ¬¡
        .mount(&mock_server)              // æŒ‚è½½åˆ°æœåŠ¡å™¨
        .await;

    // 3. è·å– mock æœåŠ¡å™¨åœ°å€
    let url = mock_server.uri();  // ä¾‹å¦‚ "http://127.0.0.1:54321"

    // 4. æµ‹è¯•ä½ çš„ä»£ç ï¼ˆè®©å®ƒè¯·æ±‚ mock æœåŠ¡å™¨ï¼‰
    // ...

    // 5. æµ‹è¯•ç»“æŸæ—¶è‡ªåŠ¨éªŒè¯ expect(1) æ˜¯å¦æ»¡è¶³
}
```

### å¸¸ç”¨ Matchers

```rust
use wiremock::matchers::*;

Mock::given(method("POST"))                          // HTTP æ–¹æ³•
    .and(path("/api/users"))                         // è·¯å¾„
    .and(header("Content-Type", "application/json")) // Header
    .and(header_exists("Authorization"))             // Header å­˜åœ¨
    .and(body_json(json!({"name": "test"})))         // JSON body
    .and(query_param("page", "1"))                   // æŸ¥è¯¢å‚æ•°
```

### å“åº”æ¨¡æ¿

```rust
ResponseTemplate::new(200)                        // çŠ¶æ€ç 
    .set_body_json(json!({"id": 1}))              // JSON body
    .insert_header("X-Custom", "value")           // è‡ªå®šä¹‰ header
    .set_delay(Duration::from_secs(2))            // æ¨¡æ‹Ÿå»¶è¿Ÿ
```

### éªŒè¯è°ƒç”¨æ¬¡æ•°

```rust
.expect(1)           // æ°å¥½ 1 æ¬¡
.expect(2..=5)       // 2-5 æ¬¡
.expect(0)           // ä¸åº”è¢«è°ƒç”¨
```

### åœ¨é¡¹ç›®ä¸­çš„ä½¿ç”¨

```rust
// tests/api/helpers.rs
pub async fn spawn_app() -> TestApp {
    let email_server = MockServer::start().await;

    let configuration = {
        let mut c = get_configuration().expect("Failed to read configuration.");
        // å…³é”®ï¼šå°† email_client çš„ base_url æŒ‡å‘ mock æœåŠ¡å™¨
        c.email_client.base_url = email_server.uri();
        c
    };

    // ...

    TestApp {
        address,
        db_pool,
        email_server,  // æš´éœ²ç»™æµ‹è¯•ä½¿ç”¨
    }
}

// tests/api/subscriptions.rs
#[tokio::test]
async fn subscribe_sends_a_confirmation_email_for_valid_data() {
    let app = spawn_app().await;

    // è®¾ç½® mock æœŸæœ›
    Mock::given(path("/email"))
        .and(method("POST"))
        .respond_with(ResponseTemplate::new(200))
        .expect(1)
        .mount(&app.email_server)
        .await;

    // å‘é€è®¢é˜…è¯·æ±‚
    app.post_subscriptions("name=Test&email=test@example.com".into()).await;

    // æµ‹è¯•ç»“æŸæ—¶ï¼Œwiremock è‡ªåŠ¨éªŒè¯æ˜¯å¦æ”¶åˆ°äº† 1 æ¬¡è¯·æ±‚
}
```

### å¯¹æ¯”ï¼šæµ‹è¯• vs ç”Ÿäº§

| åœºæ™¯     | base_url                          | è¯·æ±‚å»å‘     | å®é™…å‘é€é‚®ä»¶ |
| -------- | --------------------------------- | ------------ | ------------ |
| **æµ‹è¯•** | `mock_server.uri()` (localhost)   | wiremock     | âŒ ä¸å‘é€    |
| **ç”Ÿäº§** | `https://api.postmarkapp.com`     | Postmark API | âœ… çœŸæ­£å‘é€  |

### å“åº”å€¼æ˜¯å¦‚ä½•ç¡®å®šçš„ï¼Ÿ

**å“åº”å€¼æ˜¯ä½ åœ¨æµ‹è¯•ä¸­é¢„å…ˆè®¾å®šçš„**ï¼Œä¸æ˜¯çœŸå®æœåŠ¡è¿”å›çš„ï¼š

```rust
// ä½ å‘Šè¯‰ wiremockï¼š"å½“æ”¶åˆ°è¿™æ ·çš„è¯·æ±‚æ—¶ï¼Œè¿”å›è¿™ä¸ªå“åº”"
Mock::given(path("/email"))
    .and(method("POST"))
    .respond_with(ResponseTemplate::new(200))  // ğŸ‘ˆ ä½ å®šä¹‰çš„å“åº”
    .mount(&mock_server)
    .await;
```

### æµ‹è¯•çš„ç›®çš„

æµ‹è¯•çš„ä¸æ˜¯"Postmark èƒ½ä¸èƒ½å‘é‚®ä»¶"ï¼Œè€Œæ˜¯"ä½ çš„ä»£ç æ˜¯å¦æ­£ç¡®"ï¼š

| ä½ æµ‹è¯•çš„æ˜¯                     | ä¸æ˜¯æµ‹è¯•           |
| ------------------------------ | ------------------ |
| ä½ çš„ä»£ç æ˜¯å¦æ­£ç¡®è°ƒç”¨äº† API     | Postmark API æ˜¯å¦å·¥ä½œ |
| è¯·æ±‚æ ¼å¼æ˜¯å¦æ­£ç¡®               | ç½‘ç»œæ˜¯å¦é€šç•…       |
| æˆåŠŸ/å¤±è´¥æ—¶ä½ çš„ä»£ç å¦‚ä½•å¤„ç†    | é‚®ä»¶æ˜¯å¦çœŸæ­£é€è¾¾   |

### æµ‹è¯•ä¸åŒåœºæ™¯

```rust
// åœºæ™¯ 1ï¼šAPI è¿”å›æˆåŠŸ
#[tokio::test]
async fn email_sent_successfully() {
    let mock_server = MockServer::start().await;

    Mock::given(path("/email"))
        .respond_with(ResponseTemplate::new(200))  // æ¨¡æ‹ŸæˆåŠŸ
        .mount(&mock_server).await;

    let result = email_client.send_email(...).await;
    assert!(result.is_ok());  // éªŒè¯ä½ çš„ä»£ç æ­£ç¡®å¤„ç†äº†æˆåŠŸå“åº”
}

// åœºæ™¯ 2ï¼šAPI è¿”å› 500 é”™è¯¯
#[tokio::test]
async fn email_send_fails_on_server_error() {
    let mock_server = MockServer::start().await;

    Mock::given(path("/email"))
        .respond_with(ResponseTemplate::new(500))  // æ¨¡æ‹ŸæœåŠ¡å™¨é”™è¯¯
        .mount(&mock_server).await;

    let result = email_client.send_email(...).await;
    assert!(result.is_err());  // éªŒè¯ä½ çš„ä»£ç æ­£ç¡®å¤„ç†äº†é”™è¯¯
}

// åœºæ™¯ 3ï¼šAPI è¶…æ—¶
#[tokio::test]
async fn email_send_times_out() {
    let mock_server = MockServer::start().await;

    Mock::given(path("/email"))
        .respond_with(
            ResponseTemplate::new(200)
                .set_delay(Duration::from_secs(60))  // æ¨¡æ‹Ÿå»¶è¿Ÿ 60 ç§’
        )
        .mount(&mock_server).await;

    let result = email_client.send_email(...).await;
    assert!(result.is_err());  // éªŒè¯è¶…æ—¶å¤„ç†
}
```

### æœ¬è´¨ç†è§£

```
çœŸå®ä¸–ç•Œ:   ä½ çš„ä»£ç  â”€â”€â–¶ Postmark â”€â”€â–¶ çœŸå®å“åº”ï¼ˆä¸å¯æ§ï¼‰

æµ‹è¯•ä¸–ç•Œ:   ä½ çš„ä»£ç  â”€â”€â–¶ wiremock â”€â”€â–¶ ä½ å®šä¹‰çš„å“åº”ï¼ˆå®Œå…¨å¯æ§ï¼‰
```

**ä½ æµ‹è¯•çš„æ˜¯"ä½ çš„ä»£ç "ï¼Œä¸æ˜¯"Postmark"ã€‚** å‡è®¾ Postmark ä¼šè¿”å›å„ç§æƒ…å†µï¼ˆ200ã€500ã€è¶…æ—¶ï¼‰ï¼ŒéªŒè¯ä½ çš„ä»£ç æ˜¯å¦èƒ½æ­£ç¡®å¤„ç†è¿™äº›æƒ…å†µã€‚

### å¯¹æ¯” Node.js (nock)

```javascript
// Node.js (nock) ç‰ˆæœ¬
const nock = require('nock');

test('sends confirmation email', async () => {
  // è®¾ç½® mock
  nock('https://api.postmarkapp.com')
    .post('/email')
    .reply(200, { success: true });

  // å‘é€è¯·æ±‚
  await emailClient.sendEmail(...);

  // éªŒè¯
  expect(nock.isDone()).toBe(true);
});
```

```rust
// Rust (wiremock) ç‰ˆæœ¬
#[tokio::test]
async fn sends_confirmation_email() {
    let mock_server = MockServer::start().await;

    // è®¾ç½® mock
    Mock::given(method("POST"))
        .and(path("/email"))
        .respond_with(ResponseTemplate::new(200))
        .expect(1)
        .mount(&mock_server)
        .await;

    // å‘é€è¯·æ±‚ï¼ˆéœ€è¦å°† base_url æ›¿æ¢ä¸º mock_server.uri()ï¼‰
    email_client.send_email(...).await;

    // éªŒè¯ï¼šæµ‹è¯•ç»“æŸæ—¶è‡ªåŠ¨éªŒè¯ expect(1)
}
```

### ä¸ºä»€ä¹ˆä½¿ç”¨ Wiremockï¼Ÿ

| ä¼˜åŠ¿               | è¯´æ˜                                           |
| ------------------ | ---------------------------------------------- |
| æµ‹è¯•éš”ç¦»           | ä¸ä¾èµ–å¤–éƒ¨æœåŠ¡ï¼Œæµ‹è¯•æ›´ç¨³å®š                     |
| å¿«é€Ÿ               | æœ¬åœ° mock å“åº”ï¼Œæ— ç½‘ç»œå»¶è¿Ÿ                     |
| ä¸æ¶ˆè€— API é…é¢    | ä¸ä¼šçœŸæ­£è°ƒç”¨ä»˜è´¹ API                           |
| å¯æ§               | å¯ä»¥æ¨¡æ‹Ÿå„ç§å“åº”ï¼ˆæˆåŠŸã€å¤±è´¥ã€è¶…æ—¶ï¼‰           |
| è‡ªåŠ¨éªŒè¯           | è‡ªåŠ¨éªŒè¯è¯·æ±‚æ¬¡æ•°ã€è¯·æ±‚å†…å®¹æ˜¯å¦ç¬¦åˆé¢„æœŸ         |

### Cargo.toml é…ç½®

```toml
[dev-dependencies]
wiremock = "0.5"
```

æ³¨æ„ï¼š`wiremock` åªç”¨äºæµ‹è¯•ï¼Œæ‰€ä»¥æ”¾åœ¨ `[dev-dependencies]` ä¸­ã€‚
